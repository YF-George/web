# 團隊管理系統

這是一個遊戲團隊管理系統，支援多團隊管理、成員資訊追蹤與變更記錄。

## 🌟 特色功能

- **登入驗證**：支援一般玩家與管理員身份登入
- **多團隊管理**：管理員可建立、刪除多個團隊，自動重新編號（從 1 開始）
- **10 人團隊表單**：每個團隊固定 10 名成員
- **成員資訊**：職能（坦克/治療/輸出）、隊長、幫打、玩家 ID、裝分
- **團隊級別資訊**：發車日期/時間、副本名稱、等級、裝分限制、內容類型
- **更改紀錄追蹤**：自動記錄所有團隊變動，最多保留 100 筆
- **智能星期幾顯示**：根據日期自動計算並顯示星期幾（使用 Zeller's congruence）
- **防抖更新機制**：3 秒內的變更會合併記錄，避免過多紀錄
- **電路板風格背景**：現代化視覺設計

## 🚀 快速開始

### 1. 啟動開發伺服器

```powershell
# 安裝相依套件
pnpm install

# 啟動開發伺服器
pnpm run dev
```

### 2. 訪問團隊管理系統

開啟瀏覽器到：

```
http://localhost:5173/
```

系統會自動導向 `/forms/main` 團隊管理頁面。

### 3. 使用系統

#### **登入**

1. **一般玩家登入**：
   - 輸入遊戲 ID
   - 不輸入密碼，直接點擊「進入系統」
   - 登入後可以查看和編輯團隊資訊

2. **管理員登入**：
   - 輸入遊戲 ID（例如：千羽夜）
   - 輸入密碼（UID）
   - 登入後擁有額外權限：建立/刪除團隊

#### **管理團隊**

1. **切換團隊**：
   - 點擊頂部的團隊標籤（團隊 1、團隊 2...）
   - 每個標籤右上角的 × 可刪除團隊（管理員限定）

2. **新增團隊**：
   - 點擊「+ 添加團隊」按鈕（管理員限定）
   - 自動建立新團隊並重新編號

3. **填寫團隊資訊**：
   - **發車日期/時間**：使用 HTML5 日期/時間選擇器
   - **星期幾**：根據日期自動顯示
   - **副本名稱**、**等級**、**裝分限制**、**內容類型**：直接輸入或選擇

4. **編輯成員資訊**（每團隊 10 人）：
   - **職能**：坦克/治療/輸出
   - **隊長/幫打**：勾選標記
   - **玩家 ID**：輸入遊戲角色名稱
   - **裝分**：輸入數字

5. **查看更改紀錄**：
   - 點擊「更改紀錄」標籤
   - 查看所有團隊變動歷史（最多 100 筆）
   - 顯示操作時間、操作者、變更內容

## 📁 檔案結構

```
src/
├── lib/
│   └── assets/
│       └── favicon.svg       # 網站圖示
└── routes/
    ├── +layout.svelte        # 全域 layout（circuit-wrapper）
    ├── +page.svelte          # 首頁（自動導向 /forms/main）
    ├── layout.css            # 全域樣式（電路板背景、團隊管理樣式）
    ├── forms/[id]/
    │   └── +page.svelte      # 團隊管理頁面 UI（主要元件）
    └── api/
        ├── auth/
        │   └── +server.ts    # 登入驗證 API
        └── groups/
            └── +server.ts    # 團隊資料 API（預留）
```

## 🔒 安全性與資料管理

### 登入驗證

- **一般玩家**：僅需輸入遊戲 ID，無密碼驗證
- **管理員**：需輸入遊戲 ID + UID（密碼）
- **白名單機制**：管理員帳號儲存在後端 `ADMIN_WHITELIST`
  ```typescript
  const ADMIN_WHITELIST: Record<string, string> = {
  	千羽夜: '3025782247'
  };
  ```

### 資料儲存

目前使用**前端本地狀態管理**（$state）。生產環境建議：

- 使用資料庫（PostgreSQL、MySQL、MongoDB 等）
- 建立適當的索引（`formId`, `gameId`, `groupId`）
- 實作資料持久化（目前重新整理會遺失資料）
- 定期備份
- 實作資料保留政策

### 更改紀錄管理

- **防抖機制**：3 秒內的變更會合併為單一記錄
- **記錄上限**：每個團隊最多保留 100 筆記錄（FIFO）
- **記錄內容**：時間戳記、操作者、動作類型、詳細描述
- **自動清理**：超過上限時自動移除最舊記錄

### 資料驗證

**遊戲 ID：**

- 必填欄位
- 字串型別

**團隊成員：**

- 固定 10 人
- 職能：坦克/治療/輸出
- 玩家 ID：字串（可空）
- 裝分：數字（可空）

**團隊資訊：**

- 發車日期：YYYY-MM-DD 格式
- 發車時間：HH:mm 格式（24 小時制）
- 副本名稱、等級、裝分限制：字串（可空）
- 內容類型：俠境/百業/百業+俠境（可空）

## 📡 API 端點

### POST `/api/auth`

驗證使用者身份（一般玩家或管理員）。

**請求範例：**

```json
{
	"gameId": "千羽夜",
	"uid": "3025782247" // 選填，管理員登入時提供
}
```

**成功回應（200）：**

```json
{
	"success": true,
	"isAdmin": true,
	"gameId": "千羽夜"
}
```

**錯誤回應範例：**

- `400`：缺少 gameId
- `401`：管理員驗證失敗（帳號或密碼錯誤）
- `500`：伺服器錯誤

### GET `/api/groups?formId={id}` (預留)

取得指定表單的所有團隊資料。

**回應範例：**

```json
{
	"groups": [
		{
			"id": "1",
			"members": [...],
			"departureDate": "2025-12-24",
			"departureTime": "20:00",
			"dungeonName": "天命副本",
			"level": "90",
			"gearScoreReq": "5000",
			"contentType": "俠境"
		}
	]
}
```

### POST `/api/groups` (預留)

新增或更新團隊資料。

**請求範例：**

```json
{
	"formId": "main",
	"displayName": "千羽夜",
	"members": [...]
}
```

## 🎨 UI 功能

### 登入頁面

- 遊戲 ID 輸入欄位（必填）
- 密碼輸入欄位（選填，管理員用）
- 即時狀態回饋（loading、success、error）
- 漸層背景設計

### 團隊管理頁面

**導覽列：**

- 填寫表單 / 更改紀錄 標籤切換
- 使用者資訊顯示（遊戲 ID、身份標記）
- 登出按鈕

**團隊標籤：**

- 團隊 1、團隊 2... 標籤切換
- 刪除按鈕（管理員限定）
- 添加團隊按鈕（管理員限定）

**團隊資訊列：**

- HTML5 日期選擇器（自動顯示星期幾）
- HTML5 時間選擇器（24 小時制）
- 副本名稱、等級、裝分限制輸入
- 內容類型下拉選單（俠境/百業/百業+俠境）

**成員卡片網格（10 人）：**

- 成員編號（1-10）
- 隊長/幫打勾選框
- 職能下拉選單（坦克/治療/輸出）
- 玩家 ID 輸入
- 裝分數字輸入
- 懸停效果與過渡動畫

**更改紀錄頁面：**

- 統計資訊（變更數、最後更新時間、上限警告）
- 時間軸式記錄列表
- 動作類型標記（建立/刪除/更新團隊/日期/時間）
- 詳細變更描述
- 操作者顯示

### 響應式設計

- 桌面版（≥1201px）：5 欄網格佈局
- 平板版（769-1200px）：3 欄網格佈局
- 行動版（≤768px）：單欄堆疊佈局
- 團隊標籤：橫向捲動支援

## 🔧 環境變數

### 選用變數（部署時）

如果需要部署到生產環境並啟用資料持久化，可能需要：

```bash
# 資料庫連線（視儲存方案而定）
DATABASE_URL=postgresql://...

# Vercel KV（若使用）
KV_REST_API_URL=...
KV_REST_API_TOKEN=...

# 其他部署平台特定變數
```

**目前版本無需環境變數即可執行開發環境。**

## 🚢 部署建議

### 生產環境檢查清單

- [ ] 更換 `data/edits.json` 為正式資料庫
- [ ] 設定強隨機的 `PSEUDONYM_SALT` 環境變數
- [ ] 啟用 HTTPS（必要）
- [ ] 加入分散式速率限制（Redis）
- [ ] 整合 CAPTCHA
- [ ] 設定 CORS 規則
- [ ] 啟用日誌監控（audit log）
- [ ] 建立資料備份策略
- [ ] 加入 CSP（Content Security Policy）header
- [ ] 設定適當的 `Cache-Control` header

### 建議的 Adapter

根據部署平台選擇適當的 SvelteKit adapter：

- **Vercel**：`@sveltejs/adapter-vercel`
- **Netlify**：`@sveltejs/adapter-netlify`
- **Cloudflare Pages**：`@sveltejs/adapter-cloudflare`
- **Node.js**：`@sveltejs/adapter-node`

## 🧪 測試

### 手動測試流程

1. 啟動 dev server
2. 開啟兩個不同瀏覽器（或無痕視窗）
3. 在第一個瀏覽器：
   - 設定顯示名稱「測試者A」
   - 設定密語「test-passphrase-1」
   - 提交內容「第一則訊息」
4. 在第二個瀏覽器：
   - 設定顯示名稱「測試者B」
   - 設定密語「test-passphrase-2」
   - 提交內容「第二則訊息」
5. 確認兩個瀏覽器都能看到對方的編輯
6. 在第一個瀏覽器重新提交，確認名稱顯示一致（同一密語）

### 驗證檢查

```powershell
# 檢查 edits.json
Get-Content data\edits.json | ConvertFrom-Json | Format-List

# 驗證 pseudonym_hash 是否相同（同一密語應該產生相同 hash）
```

## 📚 延伸功能建議

### 即時同步

- WebSocket 或 Server-Sent Events (SSE)
- 當有新編輯時自動推送到所有連線的客戶端

### 衝突處理

- Operational Transformation (OT) 或 CRDT
- 視覺化衝突標記

### 富文本編輯器

- 整合 Tiptap、ProseMirror、或 Quill
- Markdown 預覽

### 版本控制

- 追蹤編輯歷史差異（diff）
- 回復到特定版本

### 權限管理

- 表單建立者可設定「唯讀」或「可編輯」
- Magic link 升級機制（保留匿名性但獲得管理權）

### 匯出功能

- 匯出為 JSON、CSV、Markdown
- 產生編輯時間軸報告

## 🐛 疑難排解

### 問題：提交後看不到自己的編輯

**可能原因：**

- 自動重新整理尚未觸發
- API 請求失敗

**解決方法：**

- 點擊手動重新整理按鈕
- 檢查瀏覽器 Console 是否有錯誤
- 確認 `data/edits.json` 檔案權限

### 問題：「rate limit exceeded」錯誤

**可能原因：**

- 短時間內提交過多次

**解決方法：**

- 等待 1 分鐘後再試
- 開發模式可調整 `checkRateLimit` 的 `maxPerMinute` 參數

### 問題：密語相同但顯示為不同人

**可能原因：**

- `PSEUDONYM_SALT` 環境變數改變
- 瀏覽器快取問題

**解決方法：**

- 確認 `PSEUDONYM_SALT` 一致
- 清除瀏覽器快取後重試

## 📄 授權

本專案遵循 MIT 授權條款。

## 🙏 貢獻

歡迎提交 Issue 或 Pull Request！

---

**注意**：這是示範專案，生產環境使用前請務必：

1. 完整的安全性審查
2. 效能測試與壓力測試
3. 隱私政策與使用條款
4. 定期安全更新
